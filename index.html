<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>Mycelium OS</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #e0e0e0;
            --accent-green: #00ff41;
            --accent-dim: #008f11;
            --accent-purple: #9d4edd;
            --accent-blue: #00d4ff;
            --alert: #ff4444;
            --warning: #ff8c00;
            --card-bg: #151515;
            --rest-color: #6a5acd;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'SF Mono', 'Courier New', monospace;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        /* Lock Screen */
        .lock-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .lock-screen.hidden { display: none; }
        .lock-logo { font-size: 4rem; margin-bottom: 20px; }
        .lock-title { font-size: 1.2rem; color: var(--accent-green); margin-bottom: 30px; letter-spacing: 2px; }
        .lock-input {
            width: 200px;
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            color: var(--accent-green);
            font-family: inherit;
            font-size: 1.2rem;
            text-align: center;
            letter-spacing: 8px;
            outline: none;
            -webkit-text-security: disc;
        }
        .lock-input:focus { border-color: var(--accent-green); }
        .lock-error { color: var(--alert); font-size: 0.8rem; margin-top: 15px; height: 20px; }
        .lock-hint { color: #444; font-size: 0.7rem; margin-top: 30px; }

        /* Main App */
        .app-container {
            display: none;
            padding: 12px;
            padding-top: max(12px, env(safe-area-inset-top));
            padding-bottom: max(70px, calc(env(safe-area-inset-bottom) + 60px));
        }
        .app-container.active { display: block; }
        
        .nav-tabs {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            display: none;
            background: #111;
            border-top: 1px solid #222;
            padding: 8px 4px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 50;
        }
        .nav-tabs.active { display: flex; }
        .nav-tab {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.55rem;
            color: #555;
            cursor: pointer;
        }
        .nav-tab.active { color: var(--accent-green); }
        .nav-tab-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
        }
        .time { font-size: 2.2rem; font-weight: bold; color: var(--accent-green); line-height: 1; }
        .date { font-size: 0.7rem; color: #555; margin-top: 4px; }
        .header-right { text-align: right; }
        .week-num { font-size: 0.6rem; color: #444; letter-spacing: 1px; }
        .question-count { font-size: 1.8rem; color: var(--accent-green); line-height: 1; }
        .question-label { font-size: 0.55rem; color: #555; }
        
        .sync-status { font-size: 0.6rem; padding: 4px 8px; border-radius: 4px; margin-top: 4px; display: inline-block; }
        .sync-status.connected { background: #001a00; color: var(--accent-green); }
        .sync-status.disconnected { background: #1a1a00; color: #888800; }
        .sync-status.syncing { background: #001a1a; color: var(--accent-blue); }

        .status-card {
            background: var(--card-bg);
            border: 1px solid #222;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .mode-label { font-size: 0.6rem; color: #444; letter-spacing: 2px; }
        .current-mode { font-size: 1.3rem; margin: 6px 0; font-weight: bold; text-transform: uppercase; color: var(--accent-green); }
        .instruction { font-size: 0.8rem; line-height: 1.5; color: #888; }
        .progress-container { background: #222; height: 3px; border-radius: 2px; margin-top: 12px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--accent-green); transition: width 1s linear; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
        .stat-box { background: var(--card-bg); border: 1px solid #222; padding: 10px 8px; border-radius: 8px; text-align: center; }
        .stat-label { font-size: 0.5rem; color: #555; letter-spacing: 1px; }
        .stat-value { font-size: 1.1rem; color: var(--accent-green); margin-top: 4px; }
        .stat-box.editable { cursor: pointer; }

        .question-card {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            border: 1px solid var(--accent-green);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .question-card-label { font-size: 0.6rem; color: var(--accent-green); letter-spacing: 1px; margin-bottom: 8px; }
        .question-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid #333;
            color: #fff;
            font-family: inherit;
            font-size: 0.9rem;
            padding: 6px 0;
            outline: none;
        }

        .task-list { margin-bottom: 12px; }
        .task-item {
            display: flex;
            align-items: center;
            background: #1a1a1a;
            margin-bottom: 6px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            border-left: 3px solid var(--accent-green);
        }
        .task-item:active { transform: scale(0.98); }
        .task-item.done { opacity: 0.35; border-left-color: #333; }
        .checkbox {
            width: 20px; height: 20px;
            border: 2px solid #444;
            margin-right: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .task-item.done .checkbox { background: var(--accent-green); border-color: var(--accent-green); color: #000; }
        .task-text { font-size: 0.85rem; }

        .output-section { background: var(--card-bg); border: 1px solid #222; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
        .output-label { font-size: 0.6rem; color: #555; letter-spacing: 1px; margin-bottom: 10px; }
        .output-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .output-btn {
            padding: 12px 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.65rem;
            cursor: pointer;
            border: 1px solid;
        }
        .output-btn:active { transform: scale(0.95); }
        .output-btn.work { background: #001a00; border-color: var(--accent-green); color: var(--accent-green); }
        .output-btn.fail { background: #1a1a00; border-color: #888800; color: #cccc00; }
        .output-btn.survive { background: #0a0a1a; border-color: var(--accent-purple); color: var(--accent-purple); }
        .output-btn-icon { font-size: 1.2rem; display: block; margin-bottom: 4px; }

        .log-card { background: var(--card-bg); border: 1px solid #222; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
        .log-label { font-size: 0.6rem; color: #555; letter-spacing: 1px; margin-bottom: 6px; }
        .log-textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--accent-green);
            font-family: inherit;
            font-size: 0.8rem;
            resize: none;
            outline: none;
            height: 45px;
        }

        .alert-row { display: flex; gap: 8px; }
        .alert-btn { flex: 1; padding: 12px; border-radius: 8px; text-align: center; font-size: 0.7rem; cursor: pointer; border: 1px solid; }
        .alert-btn.fire { background: #1a0a00; border-color: var(--warning); color: var(--warning); }
        .alert-btn.emergency { background: #1a0000; border-color: #550000; color: var(--alert); }

        .script-card { background: var(--card-bg); border: 1px solid #222; border-radius: 10px; padding: 14px; margin-bottom: 10px; }
        .script-situation { font-size: 0.7rem; color: var(--accent-purple); margin-bottom: 6px; }
        .script-text { font-size: 0.85rem; color: #ccc; line-height: 1.5; padding: 10px; background: #0a0a0a; border-radius: 6px; border-left: 2px solid var(--accent-purple); }
        .script-copy { margin-top: 8px; padding: 8px; background: #1a1a2a; border: 1px solid var(--accent-purple); border-radius: 6px; color: var(--accent-purple); font-size: 0.7rem; text-align: center; cursor: pointer; }

        .settings-section { background: var(--card-bg); border: 1px solid #222; border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .settings-section-title { font-size: 0.7rem; color: var(--accent-green); letter-spacing: 1px; margin-bottom: 12px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #222; }
        .setting-row:last-child { border-bottom: none; }
        .setting-label { font-size: 0.8rem; color: #aaa; }
        .setting-input { width: 80px; background: #0a0a0a; border: 1px solid #333; border-radius: 6px; color: var(--accent-green); font-family: inherit; font-size: 0.9rem; padding: 8px; text-align: center; outline: none; }
        .setting-input:focus { border-color: var(--accent-green); }
        .setting-input.wide { width: 100%; text-align: left; font-size: 0.75rem; }

        .activity-item { display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid #1a1a1a; font-size: 0.75rem; }
        .activity-time { color: #555; flex-shrink: 0; width: 45px; }
        .activity-icon { flex-shrink: 0; }
        .activity-text { color: #aaa; flex-grow: 1; }
        .activity-empty { text-align: center; color: #444; padding: 30px; font-size: 0.8rem; }

        .history-item { background: var(--card-bg); border: 1px solid #222; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .history-date { font-size: 0.65rem; color: #555; }
        .history-type { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-left: 8px; }
        .history-type.work { background: #001a00; color: var(--accent-green); }
        .history-type.fail { background: #1a1a00; color: #cccc00; }
        .history-type.survive { background: #0a0a1a; color: var(--accent-purple); }
        .history-type.setting { background: #001a1a; color: var(--accent-blue); }
        .history-content { font-size: 0.85rem; color: #ccc; margin-top: 6px; }
        .history-empty { text-align: center; color: #444; padding: 40px 20px; font-size: 0.8rem; }

        .export-btn { width: 100%; padding: 12px; background: #0a1a1a; border: 1px solid var(--accent-blue); border-radius: 8px; color: var(--accent-blue); font-family: inherit; font-size: 0.8rem; cursor: pointer; margin-bottom: 8px; }
        .export-btn:active { background: #0a2a2a; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card-bg); border: 1px solid #333; border-radius: 12px; padding: 20px; width: 100%; max-width: 340px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1rem; color: var(--accent-green); margin-bottom: 12px; }
        .modal-text { font-size: 0.85rem; color: #aaa; line-height: 1.6; margin-bottom: 16px; }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 8px; color: #000; font-family: inherit; font-size: 0.85rem; font-weight: bold; cursor: pointer; }
        .modal-btn.secondary { background: transparent; border: 1px solid #333; color: #888; margin-top: 8px; }

        .transmutation-mode .current-mode { color: #ff00ff; }
        .transmutation-mode .time { color: #ff00ff; }
        .transmutation-mode .status-card { border-color: #ff00ff; box-shadow: 0 0 30px rgba(255,0,255,0.15); }
        .transmutation-mode .task-item { border-left-color: #ff00ff; }
        .transmutation-mode .progress-bar { background: #ff00ff; }
        
        .rest-mode .current-mode { color: var(--rest-color); }
        .rest-mode .status-card { border-color: var(--rest-color); }
        .rest-mode .task-item { border-left-color: var(--rest-color); }
        .rest-mode .progress-bar { background: var(--rest-color); }

        .page-title { font-size: 1rem; color: #888; margin-bottom: 16px; font-weight: normal; }
        .page-title span { color: var(--accent-green); }

        .sub-tabs { display: flex; gap: 4px; margin-bottom: 16px; background: #111; padding: 4px; border-radius: 8px; }
        .sub-tab { flex: 1; padding: 10px; text-align: center; font-size: 0.7rem; color: #555; border-radius: 6px; cursor: pointer; }
        .sub-tab.active { background: var(--card-bg); color: var(--accent-green); }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 200;
            display: none;
        }
        .toast.show { display: block; animation: fadeInOut 2s ease; }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
    </style>
</head>
<body>

    <!-- Lock Screen -->
    <div class="lock-screen" id="lockScreen">
        <div class="lock-logo">ğŸ„</div>
        <div class="lock-title">MYCELIUM OS</div>
        <input type="password" class="lock-input" id="passwordInput" placeholder="â€¢â€¢â€¢â€¢" maxlength="20" autofocus>
        <div class="lock-error" id="lockError"></div>
        <div class="lock-hint">åˆå›ã¯ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š</div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <!-- Main Page -->
        <div class="page active" id="page-main">
            <div class="header">
                <div>
                    <div class="time" id="clock">00:00</div>
                    <div class="date" id="date">Loading...</div>
                    <div class="sync-status disconnected" id="syncStatus">â— Offline</div>
                </div>
                <div class="header-right">
                    <div class="week-num" id="weekNum">WEEK 1</div>
                    <div class="question-count" id="questionCount">0</div>
                    <div class="question-label">OUTPUTS</div>
                </div>
            </div>

            <div class="status-card">
                <div class="mode-label">CURRENT PROTOCOL</div>
                <div class="current-mode" id="modeText">LOADING...</div>
                <div class="instruction" id="instructionText">...</div>
                <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
            </div>

            <div class="stats-grid">
                <div class="stat-box editable" onclick="showPage('settings')">
                    <div class="stat-label">DEBT</div>
                    <div class="stat-value" id="debtDisplay">Â¥200ä¸‡</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">STREAK</div>
                    <div class="stat-value" id="streakDisplay">0é€±</div>
                </div>
                <div class="stat-box editable" onclick="showPage('settings')">
                    <div class="stat-label">WORKS</div>
                    <div class="stat-value" id="worksDisplay">1</div>
                </div>
            </div>

            <div class="question-card">
                <div class="question-card-label">ğŸ“¡ THIS WEEK'S QUESTION</div>
                <input type="text" class="question-input" id="weeklyQuestion" placeholder="ä¾‹: èŒç³¸ã§é¡”ã‚’ä½œã£ãŸã‚‰ã©ã†ãªã‚‹ã‹ï¼Ÿ">
            </div>

            <div class="task-list" id="taskList"></div>

            <div class="output-section">
                <div class="output-label">ğŸ“¤ RECORD OUTPUT</div>
                <div class="output-buttons">
                    <div class="output-btn work" onclick="recordOutput('work')"><span class="output-btn-icon">âœ¨</span>ä½œå“</div>
                    <div class="output-btn fail" onclick="recordOutput('fail')"><span class="output-btn-icon">ğŸ’€</span>å¤±æ•—</div>
                    <div class="output-btn survive" onclick="recordOutput('survive')"><span class="output-btn-icon">ğŸ«€</span>ç”Ÿå­˜</div>
                </div>
            </div>

            <div class="log-card">
                <div class="log-label">ğŸ” SCAVENGE LOG</div>
                <textarea class="log-textarea" id="logInput" placeholder="éƒ½å¸‚ã®ãƒã‚°ã‚’å…¥åŠ›..."></textarea>
            </div>

            <div class="alert-row">
                <div class="alert-btn fire" onclick="showFireWarning()">ğŸ”¥ ç«ã«ç„¼ã‹ã‚Œãã†</div>
                <div class="alert-btn emergency" onclick="showEmergency()">âš ï¸ ABORT</div>
            </div>
        </div>

        <!-- Scripts Page -->
        <div class="page" id="page-scripts">
            <h2 class="page-title">ğŸ›¡ï¸ <span>é˜²è¡›ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</span></h2>
            <div class="script-card">
                <div class="script-situation">ğŸ“‹ é ¼ã¾ã‚Œã”ã¨ã‚’ã•ã‚ŒãŸæ™‚</div>
                <div class="script-text">ã€Œæ‰¿çŸ¥ã—ã¾ã—ãŸã€‚ä»Šã¯æ‰‹ä¸€æ¯ãªã®ã§ã€ã€‡æ™‚ä»¥é™ãªã‚‰ç€æ‰‹ã§ãã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã€</div>
                <div class="script-copy" onclick="copyScript(this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</div>
            </div>
            <div class="script-card">
                <div class="script-situation">ğŸ’¬ é›‘è«‡ã‚’æŒ¯ã‚‰ã‚ŒãŸæ™‚</div>
                <div class="script-text">ã€Œãã‚Œã¯å¤§å¤‰ã§ã—ãŸã­ã€‚ã§ã€ä¾‹ã®ä»¶ã¯ã©ã†ãªã‚Šã¾ã—ãŸï¼Ÿã€</div>
                <div class="script-copy" onclick="copyScript(this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</div>
            </div>
            <div class="script-card">
                <div class="script-situation">ğŸ™… æ–­ã‚‹æ™‚</div>
                <div class="script-text">ã€Œç”³ã—è¨³ãªã„ã®ã§ã™ãŒã€ä»Šé€±ã¯ã‚­ãƒ£ãƒ‘ãŒå³ã—ãã¦ã€‚æ¥é€±ä»¥é™ãªã‚‰èª¿æ•´ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã€</div>
                <div class="script-copy" onclick="copyScript(this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</div>
            </div>
            <div class="script-card">
                <div class="script-situation">ğŸ¤ å°ã•ãªè¦ªåˆ‡ã‚’ã™ã‚‹æ™‚</div>
                <div class="script-text">ã€Œã‚‚ã—ã‚ˆã‘ã‚Œã°ã€ã€‡ã€‡ã—ã¦ãŠãã¾ã—ã‚‡ã†ã‹ï¼Ÿã€</div>
                <div class="script-copy" onclick="copyScript(this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</div>
            </div>
            <div class="script-card">
                <div class="script-situation">ğŸƒ å®šæ™‚é€€ç¤¾ã™ã‚‹æ™‚</div>
                <div class="script-text">ã€ŒãŠå…ˆã«å¤±ç¤¼ã—ã¾ã™ã€‚ä½•ã‹ã‚ã‚Œã°æ˜æ—¥å¯¾å¿œã—ã¾ã™ã­ã€‚ã€</div>
                <div class="script-copy" onclick="copyScript(this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</div>
            </div>
        </div>

        <!-- Log Page -->
        <div class="page" id="page-log">
            <h2 class="page-title">ğŸ“œ <span>æ´»å‹•ãƒ­ã‚°</span></h2>
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="showLogTab('activity')">ä»Šæ—¥</div>
                <div class="sub-tab" onclick="showLogTab('history')">å‡ºåŠ›å±¥æ­´</div>
                <div class="sub-tab" onclick="showLogTab('changes')">å¤‰æ›´</div>
            </div>
            <div id="logTab-activity" class="log-tab-content"><div id="activityList"></div></div>
            <div id="logTab-history" class="log-tab-content" style="display:none;"><div id="historyList"></div></div>
            <div id="logTab-changes" class="log-tab-content" style="display:none;"><div id="changesList"></div></div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="page-settings">
            <h2 class="page-title">âš™ï¸ <span>è¨­å®š</span></h2>

            <div class="settings-section" style="border-color: var(--accent-blue);">
                <div class="settings-section-title" style="color: var(--accent-blue);">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</div>
                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                    <div class="setting-label">GAS Web App URL</div>
                    <input type="text" class="setting-input wide" id="gasUrl" placeholder="https://script.google.com/macros/s/xxxxx/exec">
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <button class="export-btn" onclick="testConnection()" style="flex: 1;">ğŸ”— æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                    <button class="export-btn" onclick="syncAllToCloud()" style="flex: 1;">â˜ï¸ å…¨åŒæœŸ</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
                <div class="setting-row"><div class="setting-label">èµ·åºŠ</div><input type="time" class="setting-input" id="scheduleWakeUp" value="07:00"></div>
                <div class="setting-row"><div class="setting-label">å‡ºç¤¾</div><input type="time" class="setting-input" id="scheduleWorkStart" value="09:30"></div>
                <div class="setting-row"><div class="setting-label">é€€ç¤¾</div><input type="time" class="setting-input" id="scheduleWorkEnd" value="18:30"></div>
                <div class="setting-row"><div class="setting-label">å¤‰æˆå®¤</div><input type="time" class="setting-input" id="scheduleTransmutation" value="20:30"></div>
                <div class="setting-row"><div class="setting-label">å°±å¯</div><input type="time" class="setting-input" id="scheduleSleep" value="23:30"></div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <div class="setting-row"><div class="setting-label">å€Ÿé‡‘ï¼ˆä¸‡å††ï¼‰</div><input type="number" class="setting-input" id="settingDebt" value="200"></div>
                <div style="font-size: 0.7rem; color: #555; padding: 10px 0;">
                    â€» ä½œå“æ•°ãƒ»é€£ç¶šé€±æ•°ã¯å‡ºåŠ›è¨˜éŒ²ã‹ã‚‰è‡ªå‹•è¨ˆç®—
                </div>
            </div>

            <button class="modal-btn" onclick="saveAllSettings()" style="margin-bottom: 16px;">ğŸ’¾ ä¿å­˜</button>

            <div class="settings-section">
                <div class="settings-section-title">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
                <button class="export-btn" onclick="exportAllData()">ğŸ“„ JSON</button>
                <button class="export-btn" onclick="exportForNotebookLM()">ğŸ§  Notebook LMç”¨</button>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</div>
                <button class="export-btn" onclick="changePassword()" style="border-color: var(--accent-purple); color: var(--accent-purple);">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                <button class="export-btn" onclick="lockApp()" style="border-color: var(--warning); color: var(--warning);">ğŸ”’ ãƒ­ãƒƒã‚¯</button>
            </div>

            <div class="settings-section" style="border-color: #330000;">
                <div class="settings-section-title" style="color: var(--alert);">âš ï¸ DANGER</div>
                <button onclick="resetAllData()" style="width: 100%; padding: 12px; background: #1a0000; border: 1px solid var(--alert); border-radius: 8px; color: var(--alert); font-family: inherit; font-size: 0.8rem; cursor: pointer;">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <!-- AI Page -->
        <div class="page" id="page-ai">
            <h2 class="page-title">ğŸ¤– <span>AIç›¸è«‡</span></h2>
            <div class="settings-section">
                <div class="settings-section-title">ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</div>
                <button class="export-btn" onclick="generateAIPrompt()" style="border-color: var(--accent-purple); color: var(--accent-purple);">ğŸ§  ç”Ÿæˆ</button>
            </div>
            <div class="settings-section">
                <textarea id="aiPromptOutput" readonly style="width: 100%; height: 200px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: var(--accent-green); font-family: inherit; font-size: 0.7rem; padding: 12px; resize: none; outline: none;" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ..."></textarea>
                <button class="export-btn" onclick="copyAIPrompt()" style="margin-top: 8px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs" id="navTabs">
        <div class="nav-tab active" onclick="showPage('main')"><span class="nav-tab-icon">ğŸ„</span>TODAY</div>
        <div class="nav-tab" onclick="showPage('scripts')"><span class="nav-tab-icon">ğŸ›¡ï¸</span>SCRIPTS</div>
        <div class="nav-tab" onclick="showPage('log')"><span class="nav-tab-icon">ğŸ“œ</span>LOG</div>
        <div class="nav-tab" onclick="showPage('ai')"><span class="nav-tab-icon">ğŸ¤–</span>AI</div>
        <div class="nav-tab" onclick="showPage('settings')"><span class="nav-tab-icon">âš™ï¸</span>SETTINGS</div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="fireModal">
        <div class="modal">
            <div class="modal-title">ğŸ”¥ ç«ã«ç„¼ã‹ã‚Œãã†</div>
            <div class="modal-text">SNSã§è«–äº‰ï¼Ÿä¸€ç™ºé€†è»¢ç‹™ã„ï¼Ÿ<br><br>1. ã‚¹ãƒãƒ›ã‚’ç½®ã<br>2. æ·±å‘¼å¸3å›<br>3. ä»Šæ—¥ã¯ä½•ã‚‚ã—ãªã„<br><br><strong>æ—¥æ›œã¯èŒç³¸ã‚’è€ƒãˆã‚‹ãªã€‚</strong></div>
            <button class="modal-btn" onclick="closeModal('fireModal')">ç†è§£ã—ãŸ</button>
        </div>
    </div>

    <div class="modal-overlay" id="emergencyModal">
        <div class="modal">
            <div class="modal-title" style="color: var(--alert);">ğŸ›‘ EMERGENCY</div>
            <div class="modal-text">ãƒ»æ¥½ã—ããªã‘ã‚Œã°ä¸­æ–­<br>ãƒ»ç¡çœ 7æ™‚é–“çµ¶å¯¾<br>ãƒ»å€Ÿé‡‘è¿”æ¸ˆ5ä¸‡/æœˆ<br>ãƒ»å®Œç’§ã‚ˆã‚Šå®Œäº†</div>
            <button class="modal-btn" style="background: var(--alert);" onclick="closeModal('emergencyModal')">ç¢ºèªã—ãŸ</button>
        </div>
    </div>

    <div class="modal-overlay" id="outputModal">
        <div class="modal">
            <div class="modal-title" id="outputModalTitle">ğŸ“¤ å‡ºåŠ›ã‚’è¨˜éŒ²</div>
            <textarea id="outputDescription" placeholder="ä½•ã‚’å‡ºåŠ›ã—ãŸï¼Ÿ" style="width: 100%; background: #0a0a0a; border: 1px solid #333; border-radius: 6px; color: #fff; font-family: inherit; font-size: 0.85rem; padding: 10px; outline: none; resize: none; height: 80px; margin-bottom: 12px;"></textarea>
            <button class="modal-btn" onclick="confirmOutput()">è¨˜éŒ²</button>
            <button class="modal-btn secondary" onclick="closeModal('outputModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script>
        // ========== Password Protection ==========
        const PASS_KEY = 'mycelium_password_hash';
        
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }
        
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('lockError');
            const storedHash = localStorage.getItem(PASS_KEY);
            
            if (!input.value) return;
            
            if (!storedHash) {
                // First time - set password
                if (input.value.length < 4) {
                    error.innerText = '4æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„';
                    return;
                }
                localStorage.setItem(PASS_KEY, simpleHash(input.value));
                unlockApp();
            } else {
                // Check password
                if (simpleHash(input.value) === storedHash) {
                    unlockApp();
                } else {
                    error.innerText = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
                    input.value = '';
                }
            }
        }
        
        function unlockApp() {
            document.getElementById('lockScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('navTabs').classList.add('active');
            init();
        }
        
        function lockApp() {
            document.getElementById('lockScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('navTabs').classList.remove('active');
            document.getElementById('passwordInput').value = '';
            document.getElementById('lockError').innerText = '';
        }
        
        function changePassword() {
            const newPass = prompt('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆ4æ–‡å­—ä»¥ä¸Šï¼‰');
            if (newPass && newPass.length >= 4) {
                localStorage.setItem(PASS_KEY, simpleHash(newPass));
                showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
            } else if (newPass) {
                alert('4æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
        }
        
        document.getElementById('passwordInput').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') checkPassword();
        });

        // ========== State ==========
        let currentOutputType = '';
        const defaultSchedule = { wakeUp: '07:00', workStart: '09:30', workEnd: '18:30', transmutation: '20:30', sleep: '23:30' };

        // ========== Cloud Sync ==========
        function getGasUrl() { return localStorage.getItem('mycelium_gas_url') || ''; }
        function isCloudEnabled() { return getGasUrl().length > 0; }

        function updateSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            el.className = 'sync-status ' + status;
            el.innerText = { connected: 'â— Connected', disconnected: 'â— Offline', syncing: 'â— Syncing...' }[status] || 'â— Unknown';
        }

        async function sendToCloud(data) {
            const url = getGasUrl();
            if (!url) return null;
            updateSyncStatus('syncing');
            try {
                await fetch(url, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                updateSyncStatus('connected');
                return true;
            } catch (e) {
                updateSyncStatus('disconnected');
                return false;
            }
        }

        async function testConnection() {
            const url = document.getElementById('gasUrl').value;
            if (!url) { alert('URLã‚’å…¥åŠ›'); return; }
            localStorage.setItem('mycelium_gas_url', url);
            showToast('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
            await sendToCloud({ type: 'status', updates: { test: 'ok' } });
            showToast('âœ“ æ¥ç¶šå®Œäº†');
        }

        async function syncAllToCloud() {
            if (!isCloudEnabled()) { alert('URLã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
            showToast('åŒæœŸä¸­...');
            await sendToCloud({
                type: 'sync',
                outputs: JSON.parse(localStorage.getItem('mycelium_history')) || [],
                changes: JSON.parse(localStorage.getItem('mycelium_changes')) || [],
                status: { debt: localStorage.getItem('mycelium_debt') || '200', works: countWorks(), streak: calcStreak() },
                schedule: JSON.parse(localStorage.getItem('mycelium_schedule')) || defaultSchedule
            });
            showToast('âœ“ åŒæœŸå®Œäº†');
        }

        // ========== Schedule ==========
        function timeToHour(t) { const [h, m] = t.split(':').map(Number); return h + m / 60; }

        function getSchedule() {
            const s = JSON.parse(localStorage.getItem('mycelium_schedule')) || defaultSchedule;
            const wake = timeToHour(s.wakeUp), workStart = timeToHour(s.workStart), workEnd = timeToHour(s.workEnd), trans = timeToHour(s.transmutation), sleep = timeToHour(s.sleep);
            return [
                { start: 0, end: wake, mode: "Recharging", text: "7æ™‚é–“ç¡çœ æ­»å®ˆã€‚", tasks: [] },
                { start: wake, end: wake + 0.5, mode: "Wake Up", text: "èµ·åºŠã€‚æ°´åˆ†è£œçµ¦ã€‚", tasks: ["æ°´åˆ†è£œçµ¦"] },
                { start: wake + 0.5, end: wake + 1, mode: "Scavenge", text: "æ•£æ­©ã€‚", tasks: ["æ•£æ­©"] },
                { start: wake + 1, end: workStart, mode: "Commute", text: "é€šå‹¤ã€‚", tasks: ["ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ"] },
                { start: workStart, end: workEnd, mode: "Host Symbiosis", text: "æ“¬æ…‹ãƒ¢ãƒ¼ãƒ‰ã€‚", tasks: ["3å›ã«1å›è¦ªåˆ‡", "å®šæ™‚é€€ç¤¾æº–å‚™"] },
                { start: workEnd, end: workEnd + 0.5, mode: "Escape", text: "å³é€€ç¤¾ã€‚", tasks: ["é€€ç¤¾"] },
                { start: workEnd + 0.5, end: trans, mode: "Refuel", text: "å¤•é£Ÿã€‚", tasks: ["å¤•é£Ÿ", "ä»®çœ "] },
                { start: trans, end: trans + 1.5, mode: "TRANSMUTATION", text: "90åˆ†ä¸€æœ¬å‹è² ã€‚", tasks: ["90åˆ†ä½œæ¥­"] },
                { start: trans + 1.5, end: sleep, mode: "Shutdown", text: "ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ã€‚", tasks: ["å…¥æµ´"] },
                { start: sleep, end: 24, mode: "Sleep", text: "å°±å¯ã€‚", tasks: [] }
            ];
        }

        function getSaturdaySchedule() {
            return [
                { start: 0, end: 8, mode: "Recharging", text: "ã‚†ã£ãã‚Šå¯ã‚ã€‚", tasks: [] },
                { start: 8, end: 12, mode: "Creation", text: "ä½œå“åˆ¶ä½œã€‚", tasks: ["åˆ¶ä½œ"] },
                { start: 12, end: 18, mode: "Create/Rest", text: "æ’®å½±ãƒ»æŠ•ç¨¿ã€‚", tasks: ["SNS"] },
                { start: 18, end: 24, mode: "Free", text: "è‡ªç”±ã€‚", tasks: [] }
            ];
        }

        function getSundaySchedule() {
            return [{ start: 0, end: 24, mode: "REST DAY", text: "èŒç³¸ã‚’è€ƒãˆã‚‹ãªã€‚", tasks: ["ä¼‘æ¯", "æ¥é€±ã®å•ã„"] }];
        }

        function getSchedules() {
            const day = new Date().getDay();
            return day === 0 ? getSundaySchedule() : day === 6 ? getSaturdaySchedule() : getSchedule();
        }

        function getCurrentSchedule(hour) {
            return getSchedules().find(s => hour >= s.start && hour < s.end) || getSchedules()[0];
        }

        // ========== Navigation ==========
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            if (event && event.target) event.target.closest('.nav-tab').classList.add('active');
            if (id === 'log') renderActivityLog();
            if (id === 'settings') loadSettings();
        }

        function showLogTab(name) {
            document.querySelectorAll('.log-tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('logTab-' + name).style.display = 'block';
            event.target.classList.add('active');
            if (name === 'activity') renderActivityLog();
            if (name === 'history') renderHistory();
            if (name === 'changes') renderChanges();
        }

        // ========== Clock ==========
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('date').innerText = now.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', weekday: 'short' });
            const hour = now.getHours() + now.getMinutes() / 60;
            updateMode(hour);
            updateProgress(hour);
            updateWeekNumber();
        }

        function updateMode(hour) {
            const status = getCurrentSchedule(hour);
            const modeEl = document.getElementById('modeText');
            if (modeEl.innerText !== status.mode) {
                modeEl.innerText = status.mode;
                document.getElementById('instructionText').innerText = status.text;
                document.body.className = '';
                if (status.mode === "TRANSMUTATION") document.body.classList.add('transmutation-mode');
                else if (status.mode === "REST DAY") document.body.classList.add('rest-mode');
                renderTasks(status.tasks, status.mode);
            }
        }

        function updateProgress(hour) {
            const status = getCurrentSchedule(hour);
            document.getElementById('progressBar').style.width = Math.min(100, Math.max(0, ((hour - status.start) / (status.end - status.start)) * 100)) + '%';
        }

        function updateWeekNumber() {
            const now = new Date(), start = new Date(now.getFullYear(), 0, 1);
            document.getElementById('weekNum').innerText = 'WEEK ' + Math.ceil((((now - start) / 86400000) + start.getDay() + 1) / 7);
        }

        // ========== Tasks ==========
        function renderTasks(tasks, modeKey) {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            const saved = JSON.parse(localStorage.getItem('mycelium_tasks_' + new Date().toDateString())) || {};
            tasks.forEach((task, i) => {
                const key = modeKey + '_' + i, done = saved[key] || false;
                const div = document.createElement('div');
                div.className = 'task-item' + (done ? ' done' : '');
                div.innerHTML = `<div class="checkbox">${done ? 'âœ”' : ''}</div><div class="task-text">${task}</div>`;
                div.onclick = () => toggleTask(div, modeKey, i, task);
                list.appendChild(div);
            });
        }

        async function toggleTask(el, modeKey, index, taskName) {
            el.classList.toggle('done');
            const done = el.classList.contains('done');
            el.querySelector('.checkbox').innerText = done ? 'âœ”' : '';
            const key = 'mycelium_tasks_' + new Date().toDateString();
            const data = JSON.parse(localStorage.getItem(key)) || {};
            data[modeKey + '_' + index] = done;
            localStorage.setItem(key, JSON.stringify(data));
            logActivity('task', `${done ? 'âœ“' : 'â—‹'} ${taskName}`);
            if (isCloudEnabled()) await sendToCloud({ type: 'task', mode: modeKey, taskName, completed: done });
        }

        // ========== Activity ==========
        function logActivity(type, message) {
            const log = JSON.parse(localStorage.getItem('mycelium_activity_' + new Date().toDateString())) || [];
            log.push({ time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }), type, message });
            localStorage.setItem('mycelium_activity_' + new Date().toDateString(), JSON.stringify(log));
        }

        function renderActivityLog() {
            const log = JSON.parse(localStorage.getItem('mycelium_activity_' + new Date().toDateString())) || [];
            const list = document.getElementById('activityList');
            if (!log.length) { list.innerHTML = '<div class="activity-empty">ä»Šæ—¥ã®æ´»å‹•ãªã—</div>'; return; }
            list.innerHTML = log.slice().reverse().map(item => `<div class="activity-item"><div class="activity-time">${item.time}</div><div class="activity-icon">${{ mode: 'ğŸ”„', task: 'âœ…', output: 'ğŸ“¤' }[item.type] || 'ğŸ“Œ'}</div><div class="activity-text">${item.message}</div></div>`).join('');
        }

        // ========== Output ==========
        function recordOutput(type) {
            currentOutputType = type;
            document.getElementById('outputModalTitle').innerText = { work: 'âœ¨ ä½œå“', fail: 'ğŸ’€ å¤±æ•—', survive: 'ğŸ«€ ç”Ÿå­˜' }[type];
            document.getElementById('outputDescription').value = '';
            document.getElementById('outputModal').classList.add('active');
        }

        async function confirmOutput() {
            const desc = document.getElementById('outputDescription').value || 'ï¼ˆè©³ç´°ãªã—ï¼‰';
            const history = JSON.parse(localStorage.getItem('mycelium_history')) || [];
            history.unshift({ date: new Date().toISOString(), type: currentOutputType, description: desc });
            if (history.length > 100) history.pop();
            localStorage.setItem('mycelium_history', JSON.stringify(history));
            const weekKey = getWeekKey();
            localStorage.setItem('mycelium_week_' + weekKey, (parseInt(localStorage.getItem('mycelium_week_' + weekKey)) || 0) + 1);
            logActivity('output', `å‡ºåŠ›: ${currentOutputType}`);
            logChange(`å‡ºåŠ›: ${currentOutputType}`);
            if (isCloudEnabled()) await sendToCloud({ type: 'output', outputType: currentOutputType, description: desc });
            updateStats();
            closeModal('outputModal');
            showToast('âœ“ è¨˜éŒ²ã—ã¾ã—ãŸ');
        }

        function getWeekKey() {
            const now = new Date(), start = new Date(now.getFullYear(), 0, 1);
            return now.getFullYear() + '-W' + Math.ceil((((now - start) / 86400000) + start.getDay() + 1) / 7);
        }

        // ========== History ==========
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('mycelium_history')) || [];
            const list = document.getElementById('historyList');
            if (!history.length) { list.innerHTML = '<div class="history-empty">å‡ºåŠ›ãªã—</div>'; return; }
            list.innerHTML = history.map((item, index) => `<div class="history-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span class="history-date">${new Date(item.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })}</span>
                        <span class="history-type ${item.type}">${{ work: 'ä½œå“', fail: 'å¤±æ•—', survive: 'ç”Ÿå­˜' }[item.type]}</span>
                    </div>
                    <button onclick="deleteOutput(${index})" style="background: none; border: 1px solid #333; color: #666; font-size: 0.6rem; padding: 4px 8px; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
                </div>
                <div class="history-content">${item.description}</div>
            </div>`).join('');
        }

        async function deleteOutput(index) {
            if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const history = JSON.parse(localStorage.getItem('mycelium_history')) || [];
            const deleted = history[index];
            
            // å±¥æ­´ã‹ã‚‰å‰Šé™¤
            history.splice(index, 1);
            localStorage.setItem('mycelium_history', JSON.stringify(history));
            
            // å‰Šé™¤è¨˜éŒ²ã‚’Spreadsheetã«é€ä¿¡
            if (isCloudEnabled()) {
                await sendToCloud({
                    type: 'delete',
                    originalDate: deleted.date,
                    originalType: deleted.type,
                    originalDescription: deleted.description
                });
            }
            
            logChange(`å‡ºåŠ›ã‚’å‰Šé™¤: ${deleted.type}`);
            updateStats();
            renderHistory();
            showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ========== Changes ==========
        function logChange(message) {
            const changes = JSON.parse(localStorage.getItem('mycelium_changes')) || [];
            changes.unshift({ date: new Date().toISOString(), message });
            if (changes.length > 50) changes.pop();
            localStorage.setItem('mycelium_changes', JSON.stringify(changes));
        }

        function renderChanges() {
            const changes = JSON.parse(localStorage.getItem('mycelium_changes')) || [];
            const list = document.getElementById('changesList');
            if (!changes.length) { list.innerHTML = '<div class="history-empty">å¤‰æ›´ãªã—</div>'; return; }
            list.innerHTML = changes.map(i => `<div class="history-item"><span class="history-date">${new Date(i.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span><span class="history-type setting">å¤‰æ›´</span><div class="history-content">${i.message}</div></div>`).join('');
        }

        // ========== Settings ==========
        function loadSettings() {
            const s = JSON.parse(localStorage.getItem('mycelium_schedule')) || defaultSchedule;
            document.getElementById('scheduleWakeUp').value = s.wakeUp;
            document.getElementById('scheduleWorkStart').value = s.workStart;
            document.getElementById('scheduleWorkEnd').value = s.workEnd;
            document.getElementById('scheduleTransmutation').value = s.transmutation;
            document.getElementById('scheduleSleep').value = s.sleep;
            document.getElementById('settingDebt').value = localStorage.getItem('mycelium_debt') || '200';
            document.getElementById('gasUrl').value = localStorage.getItem('mycelium_gas_url') || '';
        }

        async function saveAllSettings() {
            localStorage.setItem('mycelium_schedule', JSON.stringify({
                wakeUp: document.getElementById('scheduleWakeUp').value,
                workStart: document.getElementById('scheduleWorkStart').value,
                workEnd: document.getElementById('scheduleWorkEnd').value,
                transmutation: document.getElementById('scheduleTransmutation').value,
                sleep: document.getElementById('scheduleSleep').value
            }));
            localStorage.setItem('mycelium_debt', document.getElementById('settingDebt').value);
            localStorage.setItem('mycelium_gas_url', document.getElementById('gasUrl').value);
            logChange('è¨­å®šã‚’ä¿å­˜');
            if (isCloudEnabled()) {
                await sendToCloud({ type: 'change', category: 'settings', message: 'è¨­å®šæ›´æ–°' });
                await sendToCloud({ type: 'status', updates: { debt: document.getElementById('settingDebt').value, works: countWorks(), streak: calcStreak() } });
            }
            updateStats(); updateClock();
            showToast('âœ“ ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function updateStats() {
            document.getElementById('debtDisplay').innerText = 'Â¥' + (localStorage.getItem('mycelium_debt') || '200') + 'ä¸‡';
            document.getElementById('worksDisplay').innerText = countWorks();
            document.getElementById('streakDisplay').innerText = calcStreak() + 'é€±';
            document.getElementById('questionCount').innerText = localStorage.getItem('mycelium_week_' + getWeekKey()) || '0';
            updateSyncStatus(isCloudEnabled() ? 'connected' : 'disconnected');
        }

        // ä½œå“æ•°ã‚’è‡ªå‹•ã‚«ã‚¦ãƒ³ãƒˆï¼ˆtypeãŒ'work'ã®ã‚‚ã®ã ã‘ï¼‰
        function countWorks() {
            const history = JSON.parse(localStorage.getItem('mycelium_history')) || [];
            return history.filter(item => item.type === 'work').length;
        }

        // é€£ç¶šé€±æ•°ã‚’è‡ªå‹•è¨ˆç®—
        function calcStreak() {
            const history = JSON.parse(localStorage.getItem('mycelium_history')) || [];
            if (history.length === 0) return 0;

            // å‡ºåŠ›ãŒã‚ã£ãŸé€±ã‚’é›†ã‚ã‚‹
            const weeksWithOutput = new Set();
            history.forEach(item => {
                const date = new Date(item.date);
                weeksWithOutput.add(getWeekKeyFromDate(date));
            });

            // ç¾åœ¨ã®é€±ã‹ã‚‰é¡ã£ã¦ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’è¨ˆç®—
            let streak = 0;
            let checkDate = new Date();
            
            // ä»Šé€±ã«å‡ºåŠ›ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const thisWeek = getWeekKeyFromDate(checkDate);
            if (!weeksWithOutput.has(thisWeek)) {
                // ä»Šé€±ã¾ã å‡ºåŠ›ãŒãªã„å ´åˆã€å…ˆé€±ã‹ã‚‰è¨ˆç®—é–‹å§‹
                checkDate.setDate(checkDate.getDate() - 7);
            }

            // é¡ã£ã¦ãƒã‚§ãƒƒã‚¯
            for (let i = 0; i < 52; i++) {
                const weekKey = getWeekKeyFromDate(checkDate);
                if (weeksWithOutput.has(weekKey)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 7);
                } else {
                    break;
                }
            }

            return streak;
        }

        // æ—¥ä»˜ã‹ã‚‰weekKeyã‚’å–å¾—
        function getWeekKeyFromDate(date) {
            const d = new Date(date);
            const start = new Date(d.getFullYear(), 0, 1);
            const week = Math.ceil((((d - start) / 86400000) + start.getDay() + 1) / 7);
            return d.getFullYear() + '-W' + week;
        }

        // ========== Export ==========
        function exportAllData() {
            const blob = new Blob([JSON.stringify({
                exportDate: new Date().toISOString(), version: '7.0',
                schedule: JSON.parse(localStorage.getItem('mycelium_schedule')) || defaultSchedule,
                status: { debt: localStorage.getItem('mycelium_debt'), works: countWorks(), streak: calcStreak() },
                history: JSON.parse(localStorage.getItem('mycelium_history')) || [],
                changes: JSON.parse(localStorage.getItem('mycelium_changes')) || []
            }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `mycelium-${new Date().toISOString().split('T')[0]}.json`; a.click();
        }

        function exportForNotebookLM() {
            let r = `# Mycelium OS Report\n${new Date().toLocaleString('ja-JP')}\n\n## Status\n- Debt: ${localStorage.getItem('mycelium_debt')}ä¸‡\n- Works: ${countWorks()}\n- Streak: ${calcStreak()}é€±\n\n## Outputs\n`;
            (JSON.parse(localStorage.getItem('mycelium_history')) || []).slice(0, 10).forEach(i => { r += `- [${new Date(i.date).toLocaleDateString('ja-JP')}] ${i.type}: ${i.description}\n`; });
            const blob = new Blob([r], { type: 'text/markdown' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'mycelium-report.md'; a.click();
        }

        // ========== AI ==========
        function generateAIPrompt() {
            document.getElementById('aiPromptOutput').value = `ã‚ãªãŸã¯ç§ã®å‚è¬€ã§ã™ã€‚\n\n## çŠ¶æ³\n- 27æ­³ç”·æ€§ã€ä¼šç¤¾å“¡\n- å€Ÿé‡‘: ${localStorage.getItem('mycelium_debt')}ä¸‡\n- ä½œå“æ•°: ${countWorks()}\n- é€£ç¶šå‡ºåŠ›: ${calcStreak()}é€±\n- ä»Šé€±ã®å•ã„: ${localStorage.getItem('mycelium_weekly_q') || 'æœªè¨­å®š'}\n\n## ç›®æ¨™\nèŒç³¸ã§å·¨å¤§å»ºé€ ç‰©ã‚’ä½œã‚‹ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã«ãªã‚‹\n\n## è³ªå•\n1. ä»Šé€±ã®æœ€å„ªå…ˆã¯ï¼Ÿ\n2. ãƒªã‚¹ã‚¯ã¯ï¼Ÿ\n3. ãƒ¢ãƒãƒ™ç¶­æŒæ³•ã¯ï¼Ÿ`;
        }

        function copyAIPrompt() {
            navigator.clipboard.writeText(document.getElementById('aiPromptOutput').value).then(() => showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
        }

        // ========== Misc ==========
        function copyScript(btn) { navigator.clipboard.writeText(btn.previousElementSibling.innerText).then(() => { btn.innerText = 'âœ“'; setTimeout(() => btn.innerText = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼', 1500); }); }
        function showFireWarning() { document.getElementById('fireModal').classList.add('active'); }
        function showEmergency() { document.getElementById('emergencyModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function resetAllData() { if (confirm('ãƒªã‚»ãƒƒãƒˆï¼Ÿ')) { localStorage.clear(); location.reload(); } }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        // ========== Log Input ==========
        let logTimeout;
        document.getElementById('logInput').addEventListener('input', e => {
            localStorage.setItem('scavenge_log_' + new Date().toDateString(), e.target.value);
            clearTimeout(logTimeout);
            logTimeout = setTimeout(async () => { if (isCloudEnabled() && e.target.value) await sendToCloud({ type: 'log', content: e.target.value }); }, 3000);
        });
        
        let questionTimeout;
        document.getElementById('weeklyQuestion').addEventListener('input', e => {
            localStorage.setItem('mycelium_weekly_q', e.target.value);
            clearTimeout(questionTimeout);
            questionTimeout = setTimeout(async () => { if (isCloudEnabled() && e.target.value) await sendToCloud({ type: 'question', question: e.target.value }); }, 3000);
        });

        // ========== Init ==========
        function init() {
            document.getElementById('logInput').value = localStorage.getItem('scavenge_log_' + new Date().toDateString()) || '';
            document.getElementById('weeklyQuestion').value = localStorage.getItem('mycelium_weekly_q') || '';
            updateStats(); updateClock();
            setInterval(updateClock, 1000);
        }
    </script>
</body>
</html>
